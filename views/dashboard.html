<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Magic Eden</title>
    <script>
        // Force check and restore user if missing
        window.addEventListener('load', function() {
            console.log("üîÑ Dashboard page loaded, checking auth...");
            
            // Check if user exists
            const user = localStorage.getItem('magicEdenCurrentUser');
            const token = localStorage.getItem('authToken');
            
            console.log("User in localStorage:", user);
            console.log("Token in localStorage:", token);
            
            if (!user && sessionStorage.getItem('justLoggedIn') === 'true') {
                console.log("‚ö†Ô∏è User data lost after login! Trying to recover...");
                // Try to get from URL or sessionStorage
                const urlParams = new URLSearchParams(window.location.search);
                const userFromUrl = urlParams.get('user');
                
                if (userFromUrl) {
                    localStorage.setItem('magicEdenCurrentUser', userFromUrl);
                    console.log("‚úÖ Recovered user from URL:", userFromUrl);
                }
            }
            
            // Mark that we just logged in (for next page)
            sessionStorage.setItem('justLoggedIn', 'true');
        });
      // ============================================
// DASHBOARD.JS - CORRECTED VERSION
// ============================================

let currentDashboardUser = null;
let currentConversionType = 'ethToWeth';
const ETH_PRICE = 2500;
const MARKETPLACE_WALLET_ADDRESS = "0x742d35Cc6634C0532925a3b844Bc9e90E4343A9B";

// Add this check BEFORE DOMContentLoaded
console.log("üöÄ DASHBOARD.JS LOADING - PRE-CHECK:");
console.log("magicEdenCurrentUser:", localStorage.getItem('magicEdenCurrentUser'));
console.log("AuthManager exists?", typeof AuthManager !== 'undefined');

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Dashboard DOM loaded, initializing...');
    loadDashboard();
});

// Load dashboard data
function loadDashboard() {
    console.log("üîç loadDashboard() called");
    console.log("AuthManager.isLoggedIn():", AuthManager.isLoggedIn());
    console.log("AuthManager.getCurrentUser():", AuthManager.getCurrentUser());
    
    // Use AuthManager for ALL auth checks
    if (!AuthManager.isLoggedIn()) {
        console.log("‚ùå Not logged in, redirecting to login");
        window.location.href = '/login';
        return;
    }
    
    const userEmail = AuthManager.getCurrentUser();
    console.log("Loading dashboard for:", userEmail);
    
    const users = db.getUsers();
    const user = users.find(u => u.email === userEmail.toLowerCase());
    
    if (!user) {
        console.log("‚ùå User not found in database");
        AuthManager.logout();
        window.location.href = '/login';
        return;
    }
    
    currentDashboardUser = user;
    
    // Fix user data
    db.fixUserData(userEmail);
    
    // Ensure balance fields
    if (user.balance === undefined) user.balance = 0;
    if (user.ethBalance === undefined) user.ethBalance = 0;
    if (user.wethBalance === undefined) user.wethBalance = 0;
    
    displayDashboardData(user);
    loadDashboardActivity(user.email);
    loadDashboardNFTs(user.email);
    loadRecommendedNFTs();
    updateWalletDisplay();
}

// Display dashboard data
function displayDashboardData(user) {
    // Welcome message
    const welcomeMessage = document.getElementById('welcomeMessage');
    if (welcomeMessage) {
        const name = user.fullName || user.email.split('@')[0];
        const hour = new Date().getHours();
        let greeting = "Good ";
        if (hour < 12) greeting += "morning";
        else if (hour < 18) greeting += "afternoon";
        else greeting += "evening";
        welcomeMessage.textContent = `${greeting}, ${name}!`;
    }
    
    // Update ETH balance
    const ethBalanceEl = document.getElementById('ethBalance');
    const ethValueEl = document.getElementById('ethValue');
    const marketplaceEthBalance = document.getElementById('marketplaceEthBalance');
    const marketplaceEthValue = document.getElementById('marketplaceEthValue');
    
    if (ethBalanceEl) ethBalanceEl.textContent = `${user.ethBalance.toFixed(4)} ETH`;
    if (ethValueEl) ethValueEl.textContent = `$${(user.ethBalance * ETH_PRICE).toFixed(2)}`;
    if (marketplaceEthBalance) marketplaceEthBalance.textContent = `${user.ethBalance.toFixed(4)}`;
    if (marketplaceEthValue) marketplaceEthValue.textContent = `$${(user.ethBalance * ETH_PRICE).toFixed(2)}`;
    
    // Update WETH balance
    const wethBalanceEl = document.getElementById('wethBalance');
    const wethValueEl = document.getElementById('wethValue');
    if (wethBalanceEl) wethBalanceEl.textContent = `${user.wethBalance.toFixed(4)} WETH`;
    if (wethValueEl) wethValueEl.textContent = `$${(user.wethBalance * ETH_PRICE).toFixed(2)}`;
    
    // Update marketplace wallet address
    const addressEl = document.getElementById('marketplaceAddress');
    if (addressEl) addressEl.textContent = MARKETPLACE_WALLET_ADDRESS;
}

// Setup global functions
function setupGlobalFunctions() {
    window.showWETHConversion = showWETHConversion;
    window.closeModal = closeModal;
    window.copyAddress = copyAddress;
    window.openMetaMaskBuy = openMetaMaskBuy;
    window.showDepositInstructions = showDepositInstructions;
    window.refreshBalance = refreshBalance;
    window.selectConversion = selectConversion;
    window.setMaxAmount = setMaxAmount;
    window.updateConversionPreview = updateConversionPreview;
    window.executeConversion = executeConversion;
    window.buyCrypto = buyCrypto;
    window.transferFunds = transferFunds;
    window.showStaking = showStaking;
    window.viewPortfolio = viewPortfolio;
}

// Show Add ETH Modal
function showAddETH() {
    console.log('‚ûï Opening Add ETH modal');
    document.getElementById('addETHModal').style.display = 'flex';
}

// Show WETH Conversion Modal
function showWETHConversion() {
    console.log('üí± Opening WETH conversion modal');
    
    if (!currentDashboardUser) {
        alert('Please login first');
        return;
    }
    
    // Update balances in modal
    document.getElementById('fromBalanceAmount').textContent = (currentDashboardUser.ethBalance || 0).toFixed(4);
    document.getElementById('toBalanceAmount').textContent = (currentDashboardUser.wethBalance || 0).toFixed(4);
    
    // Reset to ETH to WETH
    selectConversion('ethToWeth');
    
    // Show modal
    document.getElementById('wethConversionModal').style.display = 'flex';
}

// Close modal
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Copy address to clipboard
function copyAddress() {
    if (!navigator.clipboard) {
        alert('Clipboard not supported');
        return;
    }
    
    navigator.clipboard.writeText(MARKETPLACE_WALLET_ADDRESS)
        .then(() => {
            alert('Wallet address copied to clipboard!');
        })
        .catch(err => {
            console.error('Failed to copy:', err);
            alert('Failed to copy address');
        });
}

// Open MetaMask buy interface
function openMetaMaskBuy() {
    if (window.ethereum && window.ethereum.isMetaMask) {
        try {
            window.ethereum.request({
                method: 'wallet_buyCrypto',
                params: [{
                    address: MARKETPLACE_WALLET_ADDRESS,
                    symbol: 'ETH'
                }]
            }).then(() => {
                console.log('MetaMask buy opened');
                closeModal('addETHModal');
            }).catch((error) => {
                window.open('https://metamask.io/', '_blank');
            });
        } catch (error) {
            window.open('https://metamask.io/', '_blank');
        }
    } else {
        if (confirm('MetaMask not detected. Install it?')) {
            window.open('https://metamask.io/download/', '_blank');
        }
    }
}

// Show deposit instructions
function showDepositInstructions() {
    const instructions = document.getElementById('depositInstructions');
    if (instructions) {
        instructions.style.display = 'block';
    }
}

// Refresh balance
function refreshBalance() {
    if (currentDashboardUser) {
        displayDashboardData(currentDashboardUser);
        alert('Balance refreshed!');
    }
}

// WETH Conversion Functions
function selectConversion(type) {
    currentConversionType = type;
    
    if (type === 'ethToWeth') {
        document.getElementById('ethToWethOption').classList.add('active');
        document.getElementById('wethToEthOption').classList.remove('active');
        document.getElementById('fromCurrency').textContent = 'ETH';
        document.getElementById('toCurrency').textContent = 'WETH';
        document.getElementById('fromBalanceLabel').textContent = 'ETH Balance';
        document.getElementById('toBalanceLabel').textContent = 'WETH Balance';
        
        // Hide balance check
        document.getElementById('wethToEthBalanceCheck').style.display = 'none';
    } else {
        document.getElementById('wethToEthOption').classList.add('active');
        document.getElementById('ethToWethOption').classList.remove('active');
        document.getElementById('fromCurrency').textContent = 'WETH';
        document.getElementById('toCurrency').textContent = 'ETH';
        document.getElementById('fromBalanceLabel').textContent = 'WETH Balance';
        document.getElementById('toBalanceLabel').textContent = 'ETH Balance';
        
        // Check ETH balance
        checkWETHtoETHBalance();
    }
    
    // Reset amount
    document.getElementById('conversionAmount').value = '';
    updateConversionPreview();
}

function checkWETHtoETHBalance() {
    const balanceCheck = document.getElementById('wethToEthBalanceCheck');
    const convertButton = document.getElementById('convertButton');
    
    if (!currentDashboardUser) return;
    
    const ethBalance = currentDashboardUser.ethBalance || 0;
    const wethBalance = currentDashboardUser.wethBalance || 0;
    const requiredEth = wethBalance * 0.15;
    
    if (ethBalance < requiredEth) {
        balanceCheck.style.display = 'flex';
        balanceCheck.textContent = `Insufficient ETH balance. Need ${requiredEth.toFixed(4)} ETH (15% of WETH balance).`;
        convertButton.disabled = true;
    } else {
        balanceCheck.style.display = 'none';
        convertButton.disabled = false;
    }
}

function setMaxAmount() {
    const amountInput = document.getElementById('conversionAmount');
    if (!amountInput || !currentDashboardUser) return;
    
    let maxAmount = 0;
    if (currentConversionType === 'ethToWeth') {
        maxAmount = currentDashboardUser.ethBalance || 0;
    } else {
        maxAmount = currentDashboardUser.wethBalance || 0;
    }
    
    amountInput.value = maxAmount.toFixed(4);
    updateConversionPreview();
}

function updateConversionPreview() {
    const amountInput = document.getElementById('conversionAmount');
    const conversionResult = document.getElementById('conversionResult');
    const convertButton = document.getElementById('convertButton');
    
    if (!amountInput || !conversionResult || !convertButton || !currentDashboardUser) return;
    
    const amount = parseFloat(amountInput.value) || 0;
    
    if (amount <= 0) {
        conversionResult.textContent = currentConversionType === 'ethToWeth' ? '0.0000 WETH' : '0.0000 ETH';
        convertButton.disabled = true;
        return;
    }
    
    // Check balance
    let hasEnoughBalance = false;
    if (currentConversionType === 'ethToWeth') {
        hasEnoughBalance = amount <= (currentDashboardUser.ethBalance || 0);
    } else {
        hasEnoughBalance = amount <= (currentDashboardUser.wethBalance || 0);
    }
    
    if (!hasEnoughBalance) {
        conversionResult.textContent = 'Insufficient balance';
        convertButton.disabled = true;
        return;
    }
    
    conversionResult.textContent = `${amount.toFixed(4)} ${currentConversionType === 'ethToWeth' ? 'WETH' : 'ETH'}`;
    convertButton.disabled = false;
}

function executeConversion() {
    const amountInput = document.getElementById('conversionAmount');
    if (!amountInput || !currentDashboardUser) return;
    
    const amount = parseFloat(amountInput.value);
    if (isNaN(amount) || amount <= 0) {
        alert('Please enter a valid amount');
        return;
    }
    
    // Check balance
    if (currentConversionType === 'ethToWeth') {
        if (amount > (currentDashboardUser.ethBalance || 0)) {
            alert(`Insufficient ETH balance. You have ${currentDashboardUser.ethBalance || 0} ETH.`);
            return;
        }
    } else {
        if (amount > (currentDashboardUser.wethBalance || 0)) {
            alert(`Insufficient WETH balance. You have ${currentDashboardUser.wethBalance || 0} WETH.`);
            return;
        }
    }
    
    // Update balances
    const users = db.getUsers();
    const userIndex = users.findIndex(u => u.email === currentDashboardUser.email);
    
    if (userIndex === -1) {
        alert('Error: User not found');
        return;
    }
    
    if (currentConversionType === 'ethToWeth') {
        users[userIndex].ethBalance = (users[userIndex].ethBalance || 0) - amount;
        users[userIndex].wethBalance = (users[userIndex].wethBalance || 0) + amount;
    } else {
        users[userIndex].wethBalance = (users[userIndex].wethBalance || 0) - amount;
        users[userIndex].ethBalance = (users[userIndex].ethBalance || 0) + amount;
    }
    
    localStorage.setItem('magicEdenUsers', JSON.stringify(users));
    
    // Update current user
    currentDashboardUser.ethBalance = users[userIndex].ethBalance;
    currentDashboardUser.wethBalance = users[userIndex].wethBalance;
    
    // Update display
    displayDashboardData(currentDashboardUser);
    
    // Show success
    const fromCurrency = currentConversionType === 'ethToWeth' ? 'ETH' : 'WETH';
    const toCurrency = currentConversionType === 'ethToWeth' ? 'WETH' : 'ETH';
    alert(`Successfully converted ${amount.toFixed(4)} ${fromCurrency} to ${toCurrency}!`);
    
    closeModal('wethConversionModal');
}

// Other functions
function loadDashboardActivity(userEmail) {
    // Your existing code
}

function loadDashboardNFTs(userEmail) {
    // Your existing code
}

function loadRecommendedNFTs() {
    // Your existing code
}

function updateWalletDisplay() {
    // Your existing code
}

function buyCrypto() {
    window.location.href = '/add-eth';
}

function transferFunds() {
    alert('Transfer funds feature coming soon!');
}

function showStaking() {
    alert('Staking feature coming soon!');
}

function viewPortfolio() {
    window.location.href = '/profile';
}
    </script>

    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Header will be loaded by JavaScript -->
    
    <main class="dashboard">
        <div class="container">
            <!-- Welcome Section -->
            <div class="welcome-section">
                <h1 id="welcomeMessage">Welcome back!</h1>
                <p>Your NFT marketplace dashboard</p>
            </div>

            <!-- Wallet Balances -->
            <div class="wallet-section">
                <h2><i class="fas fa-coins"></i> Your Balances</h2>
                <div class="balance-cards">
                    <!-- ETH Balance Card -->
                    <div class="balance-card eth-card">
                        <div class="balance-icon">
                            <i class="fab fa-ethereum"></i>
                        </div>
                        <div class="balance-info">
                            <h3>ETH Balance <button class="balance-refresh" onclick="refreshBalance()" title="Refresh balance">
                                <i class="fas fa-sync-alt"></i>
                            </button></h3>
                            <div class="balance-amount" id="ethBalance">0.0000 ETH</div>
                            <div class="balance-value" id="ethValue">$0.00</div>
                        </div>
                        <a href="/add-eth" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add ETH
                        </a>
                    </div>
                    
                    <!-- WETH Balance Card -->
                    <div class="balance-card weth-card">
                        <div class="balance-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="balance-info">
                            <h3>WETH Balance</h3>
                            <div class="balance-amount" id="wethBalance">0.0000 WETH</div>
                            <div class="balance-value" id="wethValue">$0.00</div>
                        </div>
                        <a href="/convert-weth" class="btn btn-primary">
                            <i class="fas fa-exchange-alt"></i> Convert
                        </a>
                    </div>
                    
                    <!-- Portfolio Card -->
                    <div class="balance-card portfolio-card">
                        <div class="balance-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="balance-info">
                            <h3>Total Portfolio</h3>
                            <div class="balance-amount" id="portfolioValue">$0.00</div>
                            <div class="balance-change positive" id="portfolioChange">
                                <i class="fas fa-arrow-up"></i> 0.00%
                            </div>
                        </div>
                        <a href="/profile" class="btn">
                            <i class="fas fa-chart-bar"></i> Details
                        </a>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
                <div class="action-buttons">
                    <!-- Create NFT -->
                    <a href="/create-nft" class="action-btn">
                        <div class="action-icon">
                            <i class="fas fa-plus"></i>
                        </div>
                        <span>Create NFT</span>
                    </a>
                    
                    <!-- Buy Crypto -->
                    <a href="/add-eth" class="action-btn">
                        <div class="action-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <span>Buy Crypto</span>
                    </a>
                    
                    <!-- Browse NFTs -->
                    <a href="/" class="action-btn">
                        <div class="action-icon">
                            <i class="fas fa-store"></i>
                        </div>
                        <span>Browse NFTs</span>
                    </a>
                    
                    <!-- My Profile -->
                    <a href="/profile" class="action-btn">
                        <div class="action-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <span>My Profile</span>
                    </a>
                    
                    <!-- Transfer -->
                    <div class="action-btn" onclick="transferFunds()">
                        <div class="action-icon">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <span>Transfer</span>
                    </div>
                    
                    <!-- Staking -->
                    <div class="action-btn" onclick="showStaking()">
                        <div class="action-icon">
                            <i class="fas fa-lock"></i>
                        </div>
                        <span>Staking</span>
                    </div>
                </div>
            </div>

            <!-- Dashboard Grid -->
            <div class="dashboard-grid">
                <!-- Recent Activity -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-history"></i> Recent Activity</h3>
                        <a href="activity.html" class="view-all">View All</a>
                    </div>
                    <div class="activity-list" id="dashboardActivity">
                        <div class="loading">Loading activity...</div>
                    </div>
                </div>

                <!-- Your NFT Portfolio -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-gem"></i> Your NFT Portfolio</h3>
                        <a href="/profile" class="view-all">View All</a>
                    </div>
                    <div class="nft-portfolio" id="dashboardNFTs">
                        <div class="loading">Loading your NFTs...</div>
                    </div>
                </div>

                <!-- Market Trends -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-line"></i> Market Trends</h3>
                        <span class="trend-badge positive">+5.2%</span>
                    </div>
                    <div class="market-trends">
                        <div class="trend-item">
                            <div class="trend-info">
                                <span class="trend-name">Art Collection</span>
                                <span class="trend-volume">1.2K ETH volume</span>
                            </div>
                            <div class="trend-change positive">
                                <i class="fas fa-arrow-up"></i> 12.5%
                            </div>
                        </div>
                        <div class="trend-item">
                            <div class="trend-info">
                                <span class="trend-name">Gaming NFTs</span>
                                <span class="trend-volume">850 ETH volume</span>
                            </div>
                            <div class="trend-change positive">
                                <i class="fas fa-arrow-up"></i> 8.3%
                            </div>
                        </div>
                        <div class="trend-item">
                            <div class="trend-info">
                                <span class="trend-name">PFPs</span>
                                <span class="trend-volume">2.1K ETH volume</span>
                            </div>
                            <div class="trend-change negative">
                                <i class="fas fa-arrow-down"></i> 3.2%
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recommended NFTs -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-star"></i> Recommended For You</h3>
                    </div>
                    <div class="recommended-nfts" id="recommendedNFTs">
                        <div class="loading">Loading recommendations...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Load Scripts -->
    <script src="../js/app.js"></script>
    <script src="../js/dashboard.js"></script>  <!-- ‚úÖ FIXED PATH -->
</body>
</html>